<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte √âmettrice</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    #btn-appel {
      position: fixed; right: 14px; top: 14px; z-index: 1000;
      background: #ffefef; border: 2px solid #c00; color: #900;
      font-weight: 800; padding: 10px 14px; border-radius: 12px; cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="btn-appel" title="D√©clencher l'appel robot">üö® APPEL ROBOT</button>

  <script>
    // ---- Leaflet ----
    const map = L.map('map').setView([48.2, -2.75], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

    let marker = null;
    let pendingTarget = null; // position choisie mais pas encore envoy√©e

    // Clic sur la carte : positionne le MARQUEUR (mais n‚Äôenvoie rien tant qu‚Äôon n‚Äôa pas confirm√© l'appel)
    map.on('click', e => {
      const { lat, lng } = e.latlng;
      pendingTarget = { x: lat, y: lng, time: Date.now() };

      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
      console.log("üìç Position pr√™te (en attente de confirmation) :", pendingTarget);
    });

    // ---- WebSocket client (pour diffuser type:"appel") ----
    const WS_URL = "wss://sti2d.latelier22.fr/fiber-ws/";
    let ws = null, wsRetry = 0, hbTimer = null, idleTimer = null;

    function wsConnect() {
      if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        console.log("‚úÖ WS ouverte");
        wsRetry = 0;
        try { ws.send(JSON.stringify({ type: "hello", client: "emetteur-map" })); } catch {}
        startHeartbeat();
      };

      ws.onmessage = (e) => {
        // Ici on n‚Äôa rien de particulier √† recevoir (la carte √©met)
        resetIdleTimer();
      };

      ws.onerror = (err) => console.warn("‚ùå WS erreur", err);

      ws.onclose = () => {
        console.warn("üîå WS ferm√©e");
        stopHeartbeat();
        const backoff = Math.min(10000, 500 * Math.pow(2, wsRetry++));
        setTimeout(wsConnect, backoff);
      };
    }

    function wsSend(obj) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.warn("WS non ouverte, impossible d'envoyer:", obj);
        return false;
      }
      try { ws.send(JSON.stringify(obj)); return true; }
      catch(e) { console.warn("Envoi WS √©chou√©:", e); return false; }
    }

    function startHeartbeat() {
      stopHeartbeat();
      hbTimer = setInterval(() => {
        try { ws.send(JSON.stringify({ type: "ping", t: Date.now() })); } catch {}
      }, 20000);
      resetIdleTimer();
    }
    function resetIdleTimer() {
      if (idleTimer) clearTimeout(idleTimer);
      idleTimer = setTimeout(() => { try { ws.close(); } catch {} }, 45000);
    }
    function stopHeartbeat() {
      if (hbTimer) { clearInterval(hbTimer); hbTimer = null; }
      if (idleTimer) { clearTimeout(idleTimer); idleTimer = null; }
    }

    wsConnect();

    // ---- Bouton APPEL ROBOT ----
    const btn = document.getElementById('btn-appel');
    btn.addEventListener('click', () => {
      const text =
        "‚ö†Ô∏è CECI EST UN APPEL D‚ÄôURGENCE.\n\n" +
        "Confirmez-vous l‚Äôenvoi de l‚ÄôAPPEL ROBOT ?\n" +
        "‚Üí Les √©quipes √† proximit√© seront alert√©es et le robot sera appel√©.";
      if (!window.confirm(text)) return;

      // Si l‚Äôutilisateur n‚Äôa pas cliqu√© la carte, on prend le centre courant
      const target = pendingTarget ?? (() => {
        const c = map.getCenter();
        return { x: c.lat, y: c.lng, time: Date.now() };
      })();

      // 1) Envoi temps r√©el (pour l‚Äôappli Vite : ‚Äúappuyer sur le bouton appel‚Äù)
      const sentWS = wsSend({ type: "appel", data: { source: "carte-emettrice", ...target } });

      // 2) Envoi HTTP vers le webhook (position pour cr√©er le target)
      fetch('https://sti2d.latelier22.fr/fiber/api/call-robot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(target)
      })
      .then(r => r.json())
      .then(resp => {
        console.log("üì§ Webhook call-robot OK:", resp);
        if (!sentWS) alert("Appel envoy√©, mais la connexion temps r√©el n‚Äô√©tait pas ouverte.");
      })
      .catch(err => {
        console.error("‚ùå Webhook call-robot KO:", err);
        alert("√âchec de l‚Äôappel HTTP.\nV√©rifie la connexion au serveur.");
      });
    });
  </script>
</body>
</html>
